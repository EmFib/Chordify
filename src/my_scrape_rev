from selenium.webdriver import Chrome
from bs4 import BeautifulSoup
# import pandas as pd
import pymongo
import datetime
# import sys
# from urllib.parse import urlparse
# import random
import time

"""

XXXXXXXXXXX

"""

base_url = 'https://www.ultimate-guitar.com/artist/bob_dylan_10212?filter=chords&page='

def make_urls(base_url, n=9):
    '''get list of page urls for given artist'''
    artist_urls = []
    for num in range(n+1):
        artist_urls.append(base_url + str(num))
    return artist_urls


def get_all_urls(artist_urls):
    '''iterate through n pages for artist'''
    for artist_url in artist_urls:
        song_urls = get_song_urls(artist_url)
    return song_urls


def get_song_urls(artist_url):
    '''get urls to song pages'''

    # start selenium Chrome browser
    browser = Chrome()
    browser.get(artist_url)

    # download the html
    html = browser.page_source
    soup = BeautifulSoup(html, 'html.parser')

    # select the song section of the page
    sel = 'article.YMhU9 a'
    song_block = soup.select_one(sel)

    # get the song links
    song_urls = [s.attrs.get('href') for s in song_block]

    # return the list of links
    return song_urls

#
# def scrape_songs(song_urls):
#
#     song_urls = get_song_urls(artist_url)


def scrape_song_page(song_url):
    '''get raw song html from page'''
    browser.get(song_url)
    time.sleep(5)
    song_html = browser.page_source
    return song_html

if __name__ == "__main__":

    mc = pymongo.MongoClient()
    db = mc['chordify']
    raw_html = db['raw_html']

    artist_urls = make_urls(base_url, n=12)
    song_urls = get_all_urls(artist_urls)

    url = song_url
    browser = Chrome()
    browser.get(url)

    artist_urls = make_urls(base_url, n=12)
    song_urls = get_song_urls(artist_url)

    for song_url in song_urls:
        html = scrape_song_page(song_url)
        raw_html.insert_one (
            {'url': url,
             'datetime': datetime.datetime.now(),
             'html': html
            })

    time.sleep(random.randint(15,60))
